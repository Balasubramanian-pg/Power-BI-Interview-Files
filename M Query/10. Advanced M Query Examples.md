## **Advanced M Query Examples**

#### **Scenario 1: Get the Most Recent Record Within Each Category**

This is a very common requirement, such as finding the latest status update for each project or the most recent purchase for each customer.

**The Scenario:**
You have a table of product sales with multiple entries for each product on different dates. You need a table that shows only the single most recent sale (the entire row) for each unique product.

**The Challenge:**
The standard `Group By` feature only lets you aggregate data (e.g., get the `MAX` date), but it doesn't easily return the *other columns* from that specific row (like the sales amount or sales-person on that max date).

**The M Query Solution:**
This solution groups the data by `ProductID` and then uses a list function to find the record with the maximum date within each group.

```m
let
    // Sample Data Source
    Source = Table.FromRecords({
        [ProductID=1, Date=#date(2023,1,10), Sales=100, Salesperson="Bob"],
        [ProductID=2, Date=#date(2023,1,12), Sales=150, Salesperson="Sue"],
        [ProductID=1, Date=#date(2023,1,25), Sales=120, Salesperson="Bob"], // This is the latest for Product 1
        [ProductID=3, Date=#date(2023,1,5),  Sales=200, Salesperson="Tom"],
        [ProductID=2, Date=#date(2023,1,18), Sales=160, Salesperson="Sue"], // This is the latest for Product 2
        [ProductID=3, Date=#date(2023,1,20), Sales=210, Salesperson="Tom"]  // This is the latest for Product 3
    }, type table [ProductID=Int64.Type, Date=Date.Type, Sales=Int64.Type, Salesperson=Text.Type]),

    // Group the table by ProductID. This creates a nested table for each product.
    #"Grouped Rows" = Table.Group(Source, {"ProductID"}, {
        // Create a new column "LatestRecord" for each group.
        // 'each' refers to the nested table of data for one ProductID.
        {"LatestRecord", each
            // Find the record(s) within the sub-table that have the maximum date.
            let
                MaxDate = List.Max([Date]) // Find the latest date in the current product's sub-table
            in
                Table.SelectRows(_, (row) => row[Date] = MaxDate) // Select the full row where the date matches the max date
        , type table}
    }),

    // The "LatestRecord" column now contains a table with a single row. Expand it.
    #"Expanded LatestRecord" = Table.ExpandTableColumn(#"Grouped Rows", "LatestRecord",
        {"Date", "Sales", "Salesperson"}, // List the columns you want to bring out
        {"Date", "Sales", "Salesperson"}) // New names for the expanded columns
in
    #"Expanded LatestRecord"
```
**Explanation:**
1.  `Table.Group` bundles all rows for each `ProductID` into a nested table.
2.  Inside the grouping, we operate on that small, nested table (`_`).
3.  `List.Max([Date])` finds the latest date *within that specific group*.
4.  `Table.SelectRows` then filters the nested table to find the entire row corresponding to that max date.
5.  Finally, `Table.ExpandTableColumn` flattens the result to get the final table.


