## 40. How does **security trimming** interact with aggregations in composite models?

Security trimming refers to how security rules (like RLS) are applied. In composite models with aggregations, this interaction is critical to ensure both performance and data security are maintained.

#### The Setup
*   **Composite Model:** A model with a large DirectQuery table (the detail table) and a smaller, in-memory Import table (the aggregation or "agg" table).
*   **Row-Level Security (RLS):** A DAX rule is defined, typically on a dimension table (e.g., `'Salesperson'[Email] = USERPRINCIPALNAME()`). This dimension filters the fact tables.
*   **The Goal:** Power BI should hit the fast in-memory aggregation whenever possible but fall back to the slow DirectQuery source for granular queries.

#### The Interaction
1.  **Query is Issued:** A user (e.g., `user.a@company.com`) runs a report. A visual generates a DAX query for `SUM(Sales[SalesAmount])` by `Product[Category]`.
2.  **RLS is Applied First:** Before Power BI even considers the aggregation, it applies the RLS filter. The filter context now includes `Salesperson[Email] = "user.a@company.com"`.
3.  **Aggregation Matching Logic:** Power BI now looks at the query (including the RLS filter) and checks if it can be answered by the in-memory aggregation table.
    *   **Successful Hit:** If the aggregation table contains the `Salesperson` key and is at the correct grain, Power BI can apply the RLS filter to the *in-memory aggregation table*. This is the ideal scenarioâ€”it's fast and secure.
    *   **Missed Hit (The Fallback):** If the RLS filter is on a column that **does not exist** in the aggregation table, Power BI cannot use the agg. It knows the agg doesn't have the required granularity to apply the security rule correctly.
    *   **The Consequence:** The query is deemed an "agg miss." Power BI then transparently re-routes the *entire query* (including the RLS filter) to the underlying DirectQuery source. The user gets the correct, secure result, but at the cost of DirectQuery performance.

> **Key Takeaway for Design:**
> * To ensure your aggregations are effective when RLS is active, the RLS-defining dimension table must have a relationship to **both** the aggregation table and the detail table.
> * The aggregation table itself must contain the foreign key column for the dimension on which RLS is applied. If it doesn't, every query by a secured user will result in an aggregation miss.
