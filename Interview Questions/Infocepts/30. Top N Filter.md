## 30. What happens under the hood when you apply a **Top N filter** on a visual?

The Top N filter in the filter pane is a powerful feature, but its underlying DAX is more complex than it appears.

#### How it Works
1.  **DAX Generation:** When you drag a field into the "By value" section of a Top N filter, Power BI does not just sort and take the top rows. It generates a DAX query that uses the `TOPN` function.
2.  **The Generated DAX:** The conceptual DAX it creates for a "Top 10 Products by Sales" filter looks something like this:
   ```dax
   CALCULATETABLE(
       VALUES('Product'[Product Name]),
       TOPN(
           10,
           ALLSELECTED('Product'[Product Name]),
           [Total Sales],
           DESC
       )
   )
   ```
3.  **Breakdown of the DAX:**
    *   `[Total Sales]`: This is the measure used to rank the items.
    *   `ALLSELECTED('Product'[Product Name])`: This is crucial. It tells the `TOPN` function to consider **all products that are currently visible after other slicers and filters have been applied**. This is why the Top N filter interacts correctly with other slicers on the page.
    *   `TOPN(...)`: This function iterates through the list of selected products, evaluates the `[Total Sales]` for each one in the current filter context, ranks them, and returns a table containing only the top 10 product names.
    *   `CALCULATETABLE(VALUES(...), ...)`: This outer function takes the table of 10 product names returned by `TOPN` and applies it as a filter to the visual.

#### Performance Implications
*   **Iterator-Heavy:** `TOPN` is an iterator function. For each item in the list it's ranking, it has to execute a query to calculate the ranking measure (e.g., `[Total Sales]`). If you are ranking a high-cardinality column, this can be performance-intensive.
*   **Context Matters:** Because it uses `ALLSELECTED`, its performance can also be affected by the complexity of other filters applied to the page.
